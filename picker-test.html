<!doctype html>
<html>
	<head>
		<title>Google Picker Test</title>
		<script src="https://apis.google.com/js/client.js"></script>
		<script src="http://www.google.com/jsapi?key=AIzaSyCTT934cGu2bDRbCUdx1bHS8PKT5tE34WM"></script>
		<script>
			function auth() {
				gapi.auth.authorize({
					client_id: '907013371139.apps.googleusercontent.com',
					scope: 'https://www.googleapis.com/auth/drive.file',
					immediate: true
				});
			}
			
			function showPicker() {
				google.load('picker', '1', { callback: function() {
					var views = {
						docs: new google.picker.DocsView(google.picker.ViewId.DOCS_IMAGES),
						upload: new google.picker.DocsUploadView()
					};
					views.docs.setIncludeFolders(true);
					
					var picker = new google.picker.PickerBuilder()
						.setAppId('907013371139.apps.googleusercontent.com')
						.addView(views.docs)
						.addView(views.upload)
						.setCallback(onPickerAction)
						.build();
					picker.setVisible(true);
					
					function onPickerAction(data) {
						if ( data.action === google.picker.Action.PICKED ) {
							var id = data.docs[0].id;
							downloadItem(id);
						}
					}
				}});
			}
			
			function downloadItem(id) {
				var request = new XMLHttpRequest();
				var token = gapi.auth.getToken().access_token;
				request.open('GET', 'https://www.googleapis.com/drive/v2/files/' + id);
				request.setRequestHeader('Authorization', 'Bearer ' + token);
				
				request.addEventListener('error', function(e) {
					console.log(e);
				});
				request.addEventListener('abort', function(e) {
					console.log(e);
				});
				request.addEventListener('load', function() {
					var item = JSON.parse(request.responseText);
					downloadFile(item);
				});
				
				request.send();
			}
			
			function downloadFile(item) {
				var request = new XMLHttpRequest();
				var token = gapi.auth.getToken().access_token;
				request.open('GET', item.downloadUrl);
				request.responseType = 'blob';
				request.setRequestHeader('Authorization', 'Bearer ' + token);
				
				request.addEventListener('error', function(e) {
					console.log(e);
				});
				request.addEventListener('abort', function(e) {
					console.log(e);
				});
				request.addEventListener('load', function() {
					var blob = request.response;
					var url = window.URL.createObjectURL(blob);
					var img = document.createElement('img');
					img.src = url;
					
					document.body.innerHTML = '';
					document.body.appendChild(img);
				});
				
				request.send();
			}
		</script>
	</head>
	<body>
	</body>
</html>