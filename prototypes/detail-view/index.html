<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		
		<title>Detail-View/List-View</title>
		
		<script src="jquery.js"></script>
		<script src="jquery-ui.js"></script>
		<script src="knockout.js"></script>
		<script>
			var viewModel = new function() {
				var self = this;
				
				self.scenes = ko.observableArray([
					{
						name: ko.observable('City'),
						image: ko.observable('ishtar_rooftop.jpg'),
						sound: ko.observable('music.mp3'),
						text: ko.observable(null),
						color: ko.observable('#000000'),
						size: ko.observable('cover'),
						key: ko.observable('F1')
					},
					{
						name: ko.observable('Portrait'),
						image: ko.observable('jack-face-details.jpg'),
						sound: ko.observable(null),
						text: ko.observable(null),
						color: ko.observable('#ffffff'),
						size: ko.observable('contain'),
						key: ko.observable('F2')
					},
					{
						name: ko.observable('Shaman'),
						image: ko.observable('shaman-previz.jpg'),
						sound: ko.observable(null),
						text: ko.observable(null),
						color: ko.observable('#000000'),
						size: ko.observable('cover'),
						key: ko.observable('F3')
					}
				]);
				
				self.current = ko.observable();
				
				self.select = function(scene) {
					self.current(scene);
				};
				
				self.add = function() {
					self.scenes.push(wrapScene({
						name: ko.observable('Untitled scene'),
						image: ko.observable(''),
						sound: ko.observable(''),
						text: ko.observable(''),
						color: ko.observable('#000000'),
						size: ko.observable('contain'),
						key: ko.observable(null)
					}));
					self.select(self.last());
				};
				
				self.previous = function() {
					var index = self.scenes.indexOf(self.current());
					if ( index > 0 ) {
						return self.scenes()[index - 1];
					} else {
						return null;
					}
				};
				
				self.next = function() {
					var index = self.scenes.indexOf(self.current());
					if ( index < self.scenes().length - 1 ) {
						return self.scenes()[index + 1];
					} else {
						return null;
					}
				};
				
				self.last = function() {
					var index = self.scenes().length - 1;
					if ( index !== -1 ) {
						return self.scenes()[index];
					} else {
						return null;
					}
				};
				
				self.removeSelected = function() {
					var previous = self.previous();
					var next = self.next();
					
					if ( self.previous() ) {
						self.select(previous);
					} else if ( next ) {
						self.select(next);
					} else {
						self.select(null);
					}
					
					var index = viewModel.scenes.indexOf(this);
					self.scenes.splice(index, 1);
				};
				
				self.copySelected = function() {
					var newScene = {};
					for ( var property in this ) {
						newScene[property] = ko.observable(this[property]());
					};
					wrapScene(newScene);
					
					var index = self.scenes.indexOf(self.current()) + 1;
					self.scenes.splice(index, 0, newScene);
					self.select(newScene);
				};
				
				self.handleDroppedFile = function(scene, event) {
					event.preventDefault();
					event.stopPropagation();
					
					var file = event.originalEvent.dataTransfer.files[0];
					var reader = new FileReader();
					reader.onload = function(event) {
						scene.image(event.target.result);
					}
					reader.readAsDataURL(file);
				};
			}();
			
			
			
			var wrapScene = function(scene) {
				scene.imageCss = ko.computed(function() {
					return 'url("' + this.image() + '")';
				}, scene);
				scene.isSelected = ko.computed(function() {
					return this === viewModel.current();
				}, scene);
				
				return scene;
			};
			
			viewModel.scenes().map(wrapScene);
			
			window.addEventListener('load', function() {
				viewModel.current(viewModel.scenes()[0]);
				ko.applyBindings(viewModel);
				
				$('.list-view ul').sortable({
					axis: 'y'
				});
			});
		</script>
		
		<link rel="stylesheet" href="common.css">
		<link rel="stylesheet" href="sci-fi.css">
	</head>
	<body>
		<datalist id="fonts">
			<option value="Calibri">
			<option value="Cambria">
			<option value="Constantia">
			<option value="Georgia">
		</datalist>
		<div class="editor">
			<div class="editor-inner">
				<div class="list-view">
					<ul data-bind="foreach: scenes">
						<li class="list-item" data-bind="click: $root.select, css: { selected: isSelected }">
							<div class="preview" data-bind="
								style: {
									backgroundColor: color,
									backgroundImage: imageCss,
									backgroundSize: size
								}
							"></div>
							<span data-bind="text: name"></span>
							<!-- ko if: key -->
								<span data-bind="text: key" class="key"></span>
							<!-- /ko -->
						</li>
					</ul>
					<div class="add-item">
						<button data-bind="click: $root.add">Add Scene</button>
					</div>
				</div>
				<!-- ko with: current -->
				<div class="detail-view" data-bind="event: { drop: $root.handleDroppedFile }">
					<div class="selected-item">
						<ul class="action-list">
							<button class="action copy" data-bind="click: $root.copySelected">Copy</button>
							<button class="action remove" data-bind="click: $root.removeSelected">Remove</button>
						</ul>
						<div class="preview" data-bind="
							style: {
								backgroundColor: color,
								backgroundImage: imageCss,
								backgroundSize: size
							}
						">
						</div>
						<div class="options">
							<label for="name">Name</label>
							<input id="name" type="text" size="10" data-bind="value: name, valueUpdate: 'afterkeydown'">
							<label for="key">Key</label>
							<input id="key" type="text" size="1" data-bind="value: key, valueUpdate: 'afterkeydown'">
							<details>
								<summary>Image&ensp;<span class="note" data-bind="text: image"></span></summary>
								<table>
									<tr>
										<th>
											<label for="image-file">File</label>
										</th>
										<td>
											<input id="image-file" type="text" data-bind="value: image, valueUpdate: 'afterkeydown'">
										</td>
									</tr>
									<tr>
										<th>
											<label for="image-size">Size</label>
										</th>
										<td>
											<select id="image-size" data-bind="value: size">
												<option value="cover">cover</option>
												<option value="contain">contain</option>
											</select>
										</td>
									</tr>
								</table>
							</details>
							<details>
								<summary>Sound&ensp;<span class="note" data-bind="text: sound"></span></summary>
								<table>
									<tr>
										<th>
											<label for="sound-file">File</label>
										</th>
										<td>
											<input id="sound-file" type="text" data-bind="value: sound, valueUpdate: 'afterkeydown'">
										</td>
									</tr>
									<tr>
										<th><label for="loop">Loop</label></th>
										<td><input id="loop" type="checkbox" checked></td>
									</tr>
									<tr>
										<th><label for="crossover">Crossover</label></th>
										<td>
											<input id="crossover" type="number" min="0" value="0">
											<span class="note">seconds</span>
										</td>
									</tr>
									<tr>
										<th><label for="crossfade">Crossfade</label></th>
										<td><input id="crossfade" type="checkbox"></td>
									</tr>
									<tr>
										<th><label for="volume">Volume</label></th>
										<td><input id="volume" type="number" min="0" max="1" step="0.1" value="1"></td>
									</tr>
								</table>
							</details>
							<details>
								<summary>Text&ensp;<span class="note" data-bind="text: text"></span></summary>
								<table>
									<tr>
										<th><label for="text">Text</label></th>
										<td>
											<textarea id="text" data-bind="value: text, valueUpdate: 'afterkeydown'"></textarea>
										</td>
									</tr>
									<tr>
										<th>
											<label for="font">Font</label>
										</th>
										<td>
											<input id="font" type="text" list="fonts">
										</td>
									</tr>
									<tr>
										<th><label for="style">Style</label></th>
										<td>
											<select id="style">
												<option>Normal</option>
												<option>Bold</option>
												<option>Italic</option>
												<option>Bold Italic</option>
											</select>
										<//td>
									<tr>
										<th><label for="font-size">Size</label></th>
										<td>
											<input id="font-size" type="number" min="1" value="50">
											<span class="note">pixels</span>
										</td>
									</tr>
									<tr>
										<th><label for="color">Color</label></th>
										<td><input id="color" type="color"></td>
									</tr>
								</table>
							</details>
							<details>
								<summary>Other</summary>
								<table>
									<tr>
										<th><label for="background">Background color</label></th>
										<td><input id="background" type="color" data-bind="value: color"></td>
									</tr>
									<tr>
										<th><label for="fade">Fade in/out</label></th>
										<td>
											<input id="fade" type="number" min="0" value="0">
											<span class="note">seconds</span>
										</td>
									</tr>
								</table>
							</details>
						</div>
					</div>
				</div>
				<!-- /ko -->
			</div>
		</div>
		<!-- ko with: current -->
		<div class="theater preview" data-bind="
			style: {
				backgroundColor: color,
				backgroundImage: imageCss,
				backgroundSize: size
			}
		">
		</div>
		<!-- /ko -->
	</body>
</html>